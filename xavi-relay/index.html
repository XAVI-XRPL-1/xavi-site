<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XaviRelay â€” Cross-Chain Agent Payments</title>
    <link rel="icon" type="image/png" href="../xavi-logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0D0A1A;
            --bg-surface: #15112A;
            --bg-card: #1E1836;
            --bg-elevated: #251D45;
            --primary: #8B5CF6;
            --primary-light: #A855F7;
            --primary-dark: #6D28D9;
            --primary-glow: rgba(139, 92, 246, 0.4);
            --accent-blue: #3B82F6;
            --accent-cyan: #06B6D4;
            --text-primary: #F8FAFC;
            --text-secondary: #CBD5E1;
            --text-muted: #94A3B8;
            --border: #2D2550;
            --success: #22C55E;
            --warning: #F59E0B;
            --error: #EF4444;
            --gradient-cross: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 50%, #06B6D4 100%);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .bg-grid {
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(139, 92, 246, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
        }
        
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px 24px;
            background: rgba(13, 10, 26, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 100;
        }
        
        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
        }
        
        .logo img { height: 36px; }
        .logo-text { font-weight: 800; font-size: 22px; }
        .logo-text span { background: var(--gradient-cross); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .connect-btn {
            padding: 12px 24px;
            background: var(--gradient-cross);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .connect-btn:hover { transform: scale(1.02); }
        .connect-btn.connected { background: var(--bg-surface); border: 1px solid var(--success); }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 100px 24px 60px;
            position: relative;
            z-index: 1;
        }
        
        .hero {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid var(--primary);
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .hero-badge .dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        h1 { font-size: 42px; font-weight: 800; margin-bottom: 16px; }
        .gradient { background: var(--gradient-cross); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { font-size: 18px; color: var(--text-secondary); max-width: 600px; margin: 0 auto; }
        
        .tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 32px;
        }
        
        .tab {
            padding: 12px 24px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab:hover { border-color: var(--primary); color: var(--text-primary); }
        .tab.active { background: var(--primary); border-color: var(--primary); color: white; }
        
        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 24px;
        }
        
        .card-title { font-size: 20px; font-weight: 700; margin-bottom: 24px; display: flex; align-items: center; gap: 10px; }
        
        .chain-selector {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .chain-box {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .chain-box:hover { border-color: var(--primary); }
        .chain-box.active { border-color: var(--primary); background: rgba(139, 92, 246, 0.1); }
        
        .chain-icon { font-size: 32px; margin-bottom: 8px; }
        .chain-name { font-weight: 700; font-size: 16px; }
        .chain-id { font-size: 12px; color: var(--text-muted); }
        
        .arrow-icon { font-size: 24px; color: var(--primary); }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        
        .form-input {
            width: 100%;
            padding: 16px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .form-input:focus { outline: none; border-color: var(--primary); }
        .form-input::placeholder { color: var(--text-muted); }
        
        .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
        
        .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
        
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary { background: var(--gradient-cross); color: white; width: 100%; }
        .btn-primary:hover:not(:disabled) { transform: scale(1.01); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-box {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value { font-size: 28px; font-weight: 800; color: var(--primary-light); }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        
        .payment-list { margin-top: 16px; }
        
        .payment-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .payment-icon { font-size: 24px; }
        .payment-details { flex: 1; }
        .payment-route { font-weight: 600; font-size: 14px; }
        .payment-time { font-size: 12px; color: var(--text-muted); }
        .payment-amount { font-weight: 700; color: var(--success); }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .status-delivered { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .status-failed { background: rgba(239, 68, 68, 0.2); color: var(--error); }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
        
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--error); }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .footer {
            text-align: center;
            padding: 40px 24px;
            color: var(--text-muted);
            font-size: 14px;
        }
        
        .footer a { color: var(--primary-light); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        
        @media (max-width: 700px) {
            h1 { font-size: 28px; }
            .chain-selector { grid-template-columns: 1fr; }
            .arrow-icon { transform: rotate(90deg); }
            .form-row { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    
    <nav>
        <div class="nav-inner">
            <a href="https://xavi-site.vercel.app" class="logo">
                <img src="../xavi-logo.png" alt="XAVI">
                <span class="logo-text">Xavi<span>Relay</span></span>
            </a>
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">ðŸ”— Connect Wallet</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="hero">
            <div class="hero-badge">
                <span class="dot"></span>
                Powered by Axelar GMP
            </div>
            <h1><span class="gradient">Cross-Chain</span> Agent Payments</h1>
            <p class="subtitle">Send native payments between XRPL EVM and Base. Seamless agent-to-agent transfers with ERC-8004 identity support.</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showPage('send')">ðŸš€ Send</button>
            <button class="tab" onclick="showPage('history')">ðŸ“œ History</button>
            <button class="tab" onclick="showPage('receive')">ðŸ“¥ Receive</button>
        </div>
        
        <!-- Send Page -->
        <div class="page active" id="sendPage">
            <div class="card">
                <h3 class="card-title">ðŸŒ‰ Cross-Chain Transfer</h3>
                
                <div class="chain-selector">
                    <div class="chain-box active" id="sourceChain" onclick="selectSource()">
                        <div class="chain-icon">ðŸ”·</div>
                        <div class="chain-name">XRPL EVM</div>
                        <div class="chain-id">Chain 1440000</div>
                    </div>
                    <div class="arrow-icon">â†’</div>
                    <div class="chain-box" id="destChain" onclick="selectDest()">
                        <div class="chain-icon">ðŸ”µ</div>
                        <div class="chain-name">Base</div>
                        <div class="chain-id">Chain 8453</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Recipient Address</label>
                        <input type="text" class="form-input" id="recipient" placeholder="0x...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Agent ID (optional)</label>
                        <input type="number" class="form-input" id="agentId" placeholder="ERC-8004 ID">
                        <p class="form-hint">Leave empty for non-agent</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (XRP)</label>
                    <input type="number" class="form-input" id="amount" placeholder="0.0" step="0.01" min="0.01">
                    <p class="form-hint">Protocol fee: 0.5% â€¢ Gas paid via Axelar</p>
                </div>
                
                <button class="btn btn-primary" id="sendBtn" onclick="sendPayment()" disabled>
                    Connect Wallet to Send
                </button>
            </div>
            
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-value" id="totalSent">0</div>
                    <div class="stat-label">Total Sent</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalReceived">0</div>
                    <div class="stat-label">Total Received</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalPayments">0</div>
                    <div class="stat-label">Total Payments</div>
                </div>
            </div>
        </div>
        
        <!-- History Page -->
        <div class="page" id="historyPage">
            <div class="card">
                <h3 class="card-title">ðŸ“œ Payment History</h3>
                <div class="payment-list" id="paymentList">
                    <div class="empty-state">Connect wallet to view history</div>
                </div>
            </div>
        </div>
        
        <!-- Receive Page -->
        <div class="page" id="receivePage">
            <div class="card">
                <h3 class="card-title">ðŸ“¥ Receive Payments</h3>
                <div class="form-group">
                    <label class="form-label">Your Address</label>
                    <input type="text" class="form-input" id="myAddress" readonly placeholder="Connect wallet">
                </div>
                <p style="color: var(--text-muted); font-size: 14px; text-align: center; margin-top: 16px;">
                    Share this address to receive cross-chain payments from Base or other supported chains.
                </p>
                
                <div class="payment-list" style="margin-top: 24px;">
                    <h4 style="margin-bottom: 12px; color: var(--text-secondary);">Recent Incoming</h4>
                    <div id="incomingList">
                        <div class="empty-state">No incoming payments yet</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>ðŸ”· Built by Agent Xavi â€¢ <a href="https://explorer.xrplevm.org/address/0xC7f18bda49cCb1119058851871c4C72C732aF10f" target="_blank">XaviRelay Contract</a> â€¢ <a href="../xavi-identity/">ERC-8004 Identity</a></p>
    </div>
    
    <div class="toast" id="toast">
        <span id="toastIcon">âœ“</span>
        <span id="toastMsg">Success!</span>
    </div>

    <script>
        // Contract addresses
        const RELAY_ADDRESS = '0xC7f18bda49cCb1119058851871c4C72C732aF10f';
        const CHAIN_ID = 1440000;
        const RPC_URL = 'https://rpc.xrplevm.org';
        
        const RELAY_ABI = [
            'function sendPayment(string destinationChain, string destinationContract, address recipient, uint256 recipientAgentId, bytes payload) external payable returns (uint256)',
            'function payments(uint256) view returns (uint256 id, address sender, uint256 senderAgentId, string destinationChain, string destinationContract, address recipient, uint256 recipientAgentId, uint256 amount, bytes payload, uint256 timestamp, uint8 status)',
            'function paymentsBySender(address, uint256) view returns (uint256)',
            'function paymentsByRecipient(address, uint256) view returns (uint256)',
            'function protocolFeeBps() view returns (uint256)',
            'function trustedRemotes(string) view returns (string)',
            'function getVersion() view returns (string)',
            'event CrossChainPaymentSent(uint256 indexed paymentId, address indexed sender, string destinationChain, address recipient, uint256 amount)'
        ];
        
        const CHAINS = {
            'xrpl-evm': { name: 'XRPL EVM', icon: 'ðŸ”·', chainId: 1440000 },
            'base': { name: 'Base', icon: 'ðŸ”µ', chainId: 8453 }
        };
        
        let provider, signer, relay, userAddress;
        let sourceChain = 'xrpl-evm';
        let destChain = 'base';
        
        async function connectWallet() {
            if (!window.ethereum) {
                showToast('Please install MetaMask!', 'error');
                return;
            }
            
            try {
                const chainIdHex = '0x' + CHAIN_ID.toString(16);
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: chainIdHex }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: chainIdHex,
                                chainName: 'XRPL EVM Sidechain',
                                nativeCurrency: { name: 'XRP', symbol: 'XRP', decimals: 18 },
                                rpcUrls: [RPC_URL],
                                blockExplorerUrls: ['https://explorer.xrplevm.org'],
                            }],
                        });
                    }
                }
                
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                relay = new ethers.Contract(RELAY_ADDRESS, RELAY_ABI, signer);
                
                const btn = document.getElementById('connectBtn');
                btn.innerHTML = `âœ“ ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                btn.classList.add('connected');
                
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('sendBtn').textContent = 'ðŸš€ Send Cross-Chain Payment';
                document.getElementById('myAddress').value = userAddress;
                
                loadStats();
                loadHistory();
                showToast('Wallet connected!', 'success');
                
            } catch (err) {
                console.error(err);
                showToast('Failed to connect', 'error');
            }
        }
        
        function selectSource() {
            // Swap chains
            const temp = sourceChain;
            sourceChain = destChain;
            destChain = temp;
            updateChainUI();
        }
        
        function selectDest() {
            selectSource();
        }
        
        function updateChainUI() {
            const src = CHAINS[sourceChain];
            const dst = CHAINS[destChain];
            
            document.getElementById('sourceChain').innerHTML = `
                <div class="chain-icon">${src.icon}</div>
                <div class="chain-name">${src.name}</div>
                <div class="chain-id">Chain ${src.chainId}</div>
            `;
            
            document.getElementById('destChain').innerHTML = `
                <div class="chain-icon">${dst.icon}</div>
                <div class="chain-name">${dst.name}</div>
                <div class="chain-id">Chain ${dst.chainId}</div>
            `;
        }
        
        async function sendPayment() {
            const recipient = document.getElementById('recipient').value;
            const agentId = document.getElementById('agentId').value || '0';
            const amount = document.getElementById('amount').value;
            
            if (!recipient || !ethers.isAddress(recipient)) {
                showToast('Please enter a valid recipient address', 'error');
                return;
            }
            
            if (!amount || parseFloat(amount) <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Sending...';
            
            try {
                // Get trusted remote for destination chain
                const destContract = await relay.trustedRemotes(destChain);
                if (!destContract || destContract === '') {
                    showToast('Destination chain not configured yet', 'error');
                    btn.disabled = false;
                    btn.textContent = 'ðŸš€ Send Cross-Chain Payment';
                    return;
                }
                
                const amountWei = ethers.parseEther(amount);
                // Add extra for gas (Axelar requires gas payment)
                const gasValue = ethers.parseEther('0.5'); // Estimate
                const totalValue = amountWei + gasValue;
                
                const tx = await relay.sendPayment(
                    destChain,
                    destContract,
                    recipient,
                    agentId,
                    '0x', // No payload
                    { value: totalValue }
                );
                
                btn.innerHTML = '<div class="spinner"></div> Confirming...';
                await tx.wait();
                
                showToast(`Payment of ${amount} XRP sent to ${destChain}! ðŸŽ‰`, 'success');
                document.getElementById('recipient').value = '';
                document.getElementById('agentId').value = '';
                document.getElementById('amount').value = '';
                
                loadStats();
                loadHistory();
                
            } catch (err) {
                console.error(err);
                showToast('Failed: ' + (err.reason || err.message), 'error');
            }
            
            btn.disabled = false;
            btn.textContent = 'ðŸš€ Send Cross-Chain Payment';
        }
        
        async function loadStats() {
            // Stats would come from indexing payment events
            // For now show placeholder
            document.getElementById('totalPayments').textContent = '-';
            document.getElementById('totalSent').textContent = '-';
            document.getElementById('totalReceived').textContent = '-';
        }
        
        async function loadHistory() {
            const list = document.getElementById('paymentList');
            
            if (!userAddress) {
                list.innerHTML = '<div class="empty-state">Connect wallet to view history</div>';
                return;
            }
            
            list.innerHTML = '<div class="empty-state">Loading...</div>';
            
            try {
                // In production, would query events or indexer
                // For now show placeholder
                list.innerHTML = `
                    <div class="empty-state">
                        <p>ðŸ“­ No cross-chain payments yet</p>
                        <p style="font-size: 13px; margin-top: 8px;">Send your first payment above!</p>
                    </div>
                `;
            } catch (err) {
                console.error(err);
                list.innerHTML = '<div class="empty-state">Failed to load history</div>';
            }
        }
        
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = type === 'success' ? 'âœ“' : 'âœ—';
            document.getElementById('toastMsg').textContent = msg;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Init
        if (window.ethereum?.selectedAddress) connectWallet();
    </script>
</body>
</html>
